services:
  # Servicio 1: Maestros y Costos (H2 en archivo persistente)
  maestros-service:
    build: ./maestros-service
    container_name: maestros-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=default
    volumes:
      - maestros-data:/data       # H2 guarda /data/maestrosdb.*
    networks:
      - tpi-network
    restart: unless-stopped

  # Servicio 2: Operaciones y Logística (H2 en archivo persistente)
  operaciones-service:
    build: ./operaciones-service
    container_name: operaciones-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=default
    volumes:
      - operaciones-data:/data    # H2 guarda /data/operacionesdb.*
    networks:
      - tpi-network
    restart: unless-stopped

  # Servicio 3: API Gateway (no usa DB)
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "9000:9000"               # puerto público único
    networks:
      - tpi-network
    depends_on:
      - maestros-service
      - operaciones-service
    restart: unless-stopped

  # Servicio 4: Keycloak (Identity & Authentication Provider)
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    command: start-dev
    ports:
      - "8180:8080"               # host 8180 -> contenedor 8080
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - tpi-network
    restart: unless-stopped

networks:
  tpi-network:
    driver: bridge

volumes:
  maestros-data:
  operaciones-data:
  keycloak_data:
